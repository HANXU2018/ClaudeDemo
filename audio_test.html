<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音频播放测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-item {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        audio {
            width: 100%;
            margin: 10px 0;
        }
        .volume-control {
            margin: 10px 0;
        }
        #log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>🎵 音频播放测试</h1>
    
    <div class="test-item">
        <h3>1. 基础HTML5音频测试</h3>
        <audio controls preload="metadata">
            <source src="./audio/rain.mp3" type="audio/mpeg">
            您的浏览器不支持音频播放。
        </audio>
        <p>请点击上方播放器的播放按钮测试音频是否正常。</p>
    </div>

    <div class="test-item">
        <h3>2. JavaScript音频对象测试</h3>
        <div class="volume-control">
            <label>音量: </label>
            <input type="range" id="volume" min="0" max="100" value="50">
            <span id="volumeValue">50%</span>
        </div>
        <button onclick="playJSAudio()">播放雨声</button>
        <button onclick="stopJSAudio()">停止</button>
        <button onclick="playMultiple()">播放多个音频</button>
        <button onclick="stopAll()">停止全部</button>
        <div id="jsAudioStatus" class="status info">准备就绪</div>
    </div>

    <div class="test-item">
        <h3>3. 浏览器兼容性检查</h3>
        <div id="compatibility"></div>
    </div>

    <div class="test-item">
        <h3>4. 音频文件检查</h3>
        <button onclick="checkAudioFiles()">检查音频文件</button>
        <div id="audioFilesStatus"></div>
    </div>

    <div class="test-item">
        <h3>5. 调试日志</h3>
        <button onclick="clearLog()">清空日志</button>
        <div id="log"></div>
    </div>

    <script>
        let audioElements = new Map();
        let currentVolume = 50;

        // 日志函数
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logEntry.textContent = `[${time}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // 更新状态
        function updateStatus(id, message, type = 'info') {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = message;
                element.className = `status ${type}`;
            }
        }

        // 音量控制
        document.getElementById('volume').addEventListener('input', function() {
            currentVolume = this.value;
            document.getElementById('volumeValue').textContent = this.value + '%';
            
            // 更新所有音频元素的音量
            audioElements.forEach(audio => {
                audio.volume = currentVolume / 100;
            });
        });

        // 播放单个音频
        async function playJSAudio() {
            try {
                updateStatus('jsAudioStatus', '正在加载音频...', 'info');
                log('开始播放雨声音频');
                
                if (!audioElements.has('rain')) {
                    const audio = new Audio('./audio/rain.mp3');
                    audio.loop = true;
                    audio.volume = currentVolume / 100;
                    
                    audio.onloadstart = () => log('音频开始加载');
                    audio.oncanplay = () => log('音频可以播放');
                    audio.onplay = () => log('音频开始播放');
                    audio.onpause = () => log('音频暂停');
                    audio.onerror = (e) => {
                        log(`音频错误: ${e.target.error?.message || '未知错误'}`, 'error');
                        updateStatus('jsAudioStatus', '音频加载失败', 'error');
                    };
                    
                    audioElements.set('rain', audio);
                }
                
                const audio = audioElements.get('rain');
                await audio.play();
                updateStatus('jsAudioStatus', '正在播放雨声...', 'success');
                log('雨声播放成功', 'success');
                
            } catch (error) {
                log(`播放失败: ${error.message}`, 'error');
                updateStatus('jsAudioStatus', `播放失败: ${error.message}`, 'error');
            }
        }

        // 停止音频
        function stopJSAudio() {
            if (audioElements.has('rain')) {
                const audio = audioElements.get('rain');
                audio.pause();
                audio.currentTime = 0;
                updateStatus('jsAudioStatus', '已停止播放', 'info');
                log('停止播放雨声');
            }
        }

        // 播放多个音频
        async function playMultiple() {
            try {
                updateStatus('jsAudioStatus', '正在播放多个音频...', 'info');
                log('开始播放多个音频');
                
                const audioFiles = [
                    { id: 'rain', url: './audio/rain.mp3', name: '雨声' },
                    { id: 'ocean', url: './audio/ocean_waves.mp3', name: '海浪' },
                    { id: 'white_noise', url: './audio/white_noise.mp3', name: '白噪音' }
                ];
                
                const promises = audioFiles.map(async (file) => {
                    try {
                        if (!audioElements.has(file.id)) {
                            const audio = new Audio(file.url);
                            audio.loop = true;
                            audio.volume = currentVolume / 100;
                            audioElements.set(file.id, audio);
                            log(`创建音频对象: ${file.name}`);
                        }
                        
                        const audio = audioElements.get(file.id);
                        await audio.play();
                        log(`成功播放: ${file.name}`, 'success');
                        return { success: true, name: file.name };
                    } catch (error) {
                        log(`播放失败 ${file.name}: ${error.message}`, 'error');
                        return { success: false, name: file.name, error };
                    }
                });
                
                const results = await Promise.allSettled(promises);
                const successful = results.filter(r => r.status === 'fulfilled' && r.value.success).length;
                
                updateStatus('jsAudioStatus', `播放了 ${successful}/${audioFiles.length} 个音频`, 
                    successful > 0 ? 'success' : 'error');
                    
            } catch (error) {
                log(`批量播放失败: ${error.message}`, 'error');
                updateStatus('jsAudioStatus', `批量播放失败: ${error.message}`, 'error');
            }
        }

        // 停止全部
        function stopAll() {
            audioElements.forEach((audio, id) => {
                audio.pause();
                audio.currentTime = 0;
                log(`停止播放: ${id}`);
            });
            updateStatus('jsAudioStatus', '已停止所有音频', 'info');
        }

        // 检查浏览器兼容性
        function checkCompatibility() {
            const compatDiv = document.getElementById('compatibility');
            let html = '<ul>';
            
            // Audio API support
            html += `<li>Audio API: ${typeof Audio !== 'undefined' ? '✅ 支持' : '❌ 不支持'}</li>`;
            
            // MP3 support
            const audio = new Audio();
            const mp3Support = audio.canPlayType('audio/mpeg');
            html += `<li>MP3 支持: ${mp3Support ? '✅ ' + mp3Support : '❌ 不支持'}</li>`;
            
            // User gesture requirement
            html += `<li>用户手势要求: 现代浏览器需要用户交互后才能播放音频</li>`;
            
            // Volume control
            html += `<li>音量控制: ${typeof audio.volume !== 'undefined' ? '✅ 支持' : '❌ 不支持'}</li>`;
            
            // CORS
            html += `<li>跨域支持: 需要正确的服务器配置</li>`;
            
            html += '</ul>';
            compatDiv.innerHTML = html;
        }

        // 检查音频文件
        async function checkAudioFiles() {
            const statusDiv = document.getElementById('audioFilesStatus');
            statusDiv.innerHTML = '<p>正在检查音频文件...</p>';
            
            const audioFiles = [
                'rain.mp3', 'ocean_waves.mp3', 'white_noise.mp3', 
                'birds_chirping.mp3', 'fireplace.mp3'
            ];
            
            let html = '<ul>';
            
            for (const file of audioFiles) {
                try {
                    const response = await fetch(`./audio/${file}`, { method: 'HEAD' });
                    const size = response.headers.get('content-length');
                    const sizeKB = size ? Math.round(size / 1024) : '未知';
                    
                    if (response.ok) {
                        html += `<li>✅ ${file} (${sizeKB} KB)</li>`;
                        log(`文件检查成功: ${file} (${sizeKB} KB)`, 'success');
                    } else {
                        html += `<li>❌ ${file} - HTTP ${response.status}</li>`;
                        log(`文件检查失败: ${file} - HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    html += `<li>❌ ${file} - ${error.message}</li>`;
                    log(`文件检查错误: ${file} - ${error.message}`, 'error');
                }
            }
            
            html += '</ul>';
            statusDiv.innerHTML = html;
        }

        // 清空日志
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // 页面加载完成后检查兼容性
        window.addEventListener('DOMContentLoaded', () => {
            log('页面加载完成');
            checkCompatibility();
            
            // 检测用户是否已经与页面交互
            let hasInteracted = false;
            const updateInteractionStatus = () => {
                if (!hasInteracted) {
                    hasInteracted = true;
                    log('用户已与页面交互，音频播放权限已激活', 'success');
                }
            };
            
            document.addEventListener('click', updateInteractionStatus, { once: true });
            document.addEventListener('touchstart', updateInteractionStatus, { once: true });
            document.addEventListener('keydown', updateInteractionStatus, { once: true });
        });
    </script>
</body>
</html>